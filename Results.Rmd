---
title: "Final Project"
author: "Anna MacFarlane, Edgar Salas, Jerry Fu, Taalin RaoShah"
date: "10/27/2020"
output:
  pdf_document: default
  html_document: default
---
### Introduction
CodeStone chose to explore the data from the World Happiness Reports of 2018 and 2019, published by the Sustainable Development Network. According to the WHR, this data is derived from the Gallup World Poll, a systematic telephone survey and in person interviews in over 160 countries whose surveys claim to represent 80%+ of the population (2014). The calls are made via random phone number generation and randomly selecting households (GWP, 2014). 

Generally, we want to explore the following question: which factors correlate most strongly to happiness across the globe? We chose to focus on four variables as well as the overall happiness score in our analysis. The four variables chosen were GDP per capita, Perceptions of Corruption, Social Support, and Life Expectancy, selected because we thought they represented economic, political, social, and medical aspects of well being respectively. Furthermore, the data set included 312 cases, each representing the data for a particular country. Guided by our general research question, we also examined the variation of their distribution by region, and which of these factors have the strongest correlations.

Considering the concerning state of our world in 2020, including the worsening effects of climate change, threats to democracy, and much more, we found it topical and insightful to evaluate what contributes to happiness within each nation and across the globe. The first World Happiness Report, published in 2012, presents the report as a means of grappling with the countless contradictions that exist in modern society such as the balance between pursuing economic success versus protecting the environment or the tradeoffs between personal profit and community trust (Helliwell et al., 2012). Eight years later, these paradoxes persit, and the potential solutions are closely linked to definitions of morality, heightening their controversy. Considering the continued debate over such questions, we believe there are grounds for further investigation into trends of happiness over time and the factors that contribute to it.


```{r setup-packages, message = FALSE, warning = FALSE}
library(tidyverse)
library(plyr) #package for join command
library(maps) #package for world map
library(broom)
```

```{r load-datasets, message = FALSE, warning = FALSE}
report_2018 <- read_csv("data/2018.csv") %>% 
  mutate(year = "2018",
         `Perceptions of corruption` = as.numeric(`Perceptions of corruption`))
report_2019 <- read_csv("data/2019.csv") %>% 
  mutate(year = "2019")
country_region <- read_csv("data/2020.csv") %>% 
  mutate(year = "2020") %>% 
  select(`Country name`, `Regional indicator`)

names(country_region) <- c("Country", "Region")
names(report_2018) <- str_replace_all(names(report_2018), c(" " = "_"))
names(report_2019) <- str_replace_all(names(report_2018), c(" " = "_"))

worldhappiness <- full_join(report_2018, report_2019) 
worldhappiness <- worldhappiness %>% 
  rename(c("Country_or_region" = "Country")) %>% 
  left_join(country_region)

glimpse(worldhappiness)
```

```{r add-region}
worldhappiness %>% 
  filter(is.na(Region))

worldhappiness <- worldhappiness %>% 
  mutate(Region = ifelse(Country == "Taiwan", "East Asia", Region)) %>%
  mutate(Region = ifelse(Country == "Qatar", "Middle East and North Africa", Region)) %>% 
  mutate(Region = ifelse(Country == "Trinidad & Tobago", "Latin America and Caribbean", Region)) %>% 
  mutate(Region = ifelse(Country == "Belize", "Latin America and Caribbean", Region)) %>% 
  mutate(Region = ifelse(Country == "Northern Cyprus", "Middle East and North Africa", Region)) %>% 
  mutate(Region = ifelse(Country == "Hong Kong", "East Asia", Region)) %>% 
  mutate(Region = ifelse(Country == "Bhutan", "South Asia", Region)) %>% 
  mutate(Region = ifelse(Country == "Somalia", "Middle East and North Africa", Region)) %>% 
  mutate(Region = ifelse(Country == "Sudan", "Middle East and North Africa", Region)) %>% 
  mutate(Region = ifelse(Country == "Angola", "Middle East and North Africa", Region)) %>% 
  mutate(Region = ifelse(Country == "Syria", "Middle East and North Africa", Region)) %>% 
  mutate(Region = ifelse(Country == "North Macedonia", "Central and Eastern Europe", Region))
```
### Methodology

First, we did a general overview of the distribution of Happiness Scores across different countries and regions. In the map colored by Happiness Score, we noticed that countries in different regions of the world tended to have different happiness scores. In order to see if what we were visualizing was statistically significant, a chi-squared test was used to test if there was an association between Happiness Score and Region. A chi-squared test statistic is computed by adding up the squares of the difference between the observed and expected values in a table, divided by the expected values. The expected values are equal to the row total multiplied by the column total, and divided by the overall total. Finally, p-values are derived from degrees of freedom and the chi-square test statistic. A very small chi-square test statistic means that your observed data fits your expected data well and that a relationship exists, while a large chi-square test statistic means the opposite. In our case, our null hypothesis was that there isn’t an association between region and happiness, and our alternative hypothesis was that there was an association between region and happiness. With a p-value of 0.1253, we did not have sufficient evidence to reject the null hypothesis at an alpha of 0.05. However, the Pearson chi-square test might not be appropriate for our dataset, which we will discuss more in our discussion section. Disregarding this for now, we moved on to looking at the individual metrics which went into determining happiness score.
In trying to answer the extent to which factors are most important in affecting Happiness, we looked at GDP per capita, Perceptions of Corruption, Social Support, and Life Expectancy. 

Variable Sources and Definitions
	
	Happiness Score: Happiness score is a self-reported measure of overall current life satisfaction. This was measured by asking respondents, “Please imagine a ladder, with steps numbered from 0 at the bottom to 10 at the top. The top of the ladder represents the best possible life for you and the bottom of the ladder represents the worst possible life for you. On which step of the ladder would you say you personally feel you stand at this time?” The average of these values represents respective countries and regions (Helliwell et al, 2018; Helliwell et al, 2019). 

	GDP per capita: PPP (purchasing power parity) is a rate of conversion which attempts to equalize the purchasing power across all different currencies. The World Happiness Report sources its GDP per capita in PPP values from the 2017 and 2018 World Development Indicators respectively. This value is logged. (Helliwell et al, 2018; Helliwell et al, 2019). 

	Social Support: Social support is a self-reported measure of whether or not the respondent feels they can be helped. Specifically, respondents were asked, “If you were in trouble, do you have relatives or friends you can count on to help you whenever you need them, or not?” and responded with 0 or 1 (no or yes). The average for each respective country or region creates this value (Helliwell et al, 2018; Helliwell et al, 2019). 

	Life Expectancy: Life expectancy data was extrapolated from the WHOs health observation data up to 2016. Where missing, life expectancy data for certain countries was found using research and government tools (Helliwell et al, 2018; Helliwell et al, 2019). 

	Perceptions of Corruption: Perception of Corruption is a self-reported measure of whether or not respondents feel there is active corruption within government and business. Specifically, respondents were asked, “Is corruption widespread throughout the government or not” and “Is corruption widespread within businesses or not?” and responded to both with 0 or 1 (no or yes). The average for each respective country or region creates this value (Helliwell et al, 2018; Helliwell et al, 2019). 

Helliwell, J., Layard, R., & Sachs, J. (2018). World Happiness Report 2018, New York: Sustainable Development Solutions Network.

Helliwell, J., Layard, R., & Sachs, J. (2019). World Happiness Report 2019, New York: Sustainable Development Solutions Network.


### Results 

### Is there a relationship between region of the world and happiness score?
```{r world-map, fig.width = 10, fig.height = 5}
world_map <- map_data("world") %>% 
  mutate(region = ifelse(region == "USA", "United States", region)) %>% 
  mutate(region = ifelse(region == "Democratic Republic of the Congo", "Congo (Kinshasa)", region))
  
happiness_score_map <- left_join(worldhappiness, world_map, by = c("Country" = "region"))
ggplot(happiness_score_map, aes(x = long, y = lat, group = group)) +
  geom_polygon(aes(fill = Score), color = "white") +
  labs(title = "World Map", subtitle = "colored by Happiness Score", x = "", y = "") +
  scale_fill_viridis_c(option = "D")
```
https://www.datanovia.com/en/blog/how-to-create-a-map-using-ggplot2/

```{r chi-sq-region-score}
chisq.test(worldhappiness$Score, worldhappiness$Region)
```

### Multiple regression for all considered factors 

```{r multiple-reg-for-all}
m_happy <- lm(Score ~ Perceptions_of_corruption + Social_support +
                GDP_per_capita + Healthy_life_expectancy, data = worldhappiness)

m_happy %>% 
  tidy() %>%
  select(term, estimate) 

glance(m_happy)$r.squared
```

### Perceptions of Corruption 

<<<<<<< HEAD
```{r linear-model-corrupt, message = FALSE}
# Linear model for relationship between perceptions of corruption score and # overall happiness score
```

```{r linear-model-corrupt, message = FALSE, warning = FALSE}
# Linear model for relationship between perceptions of corruption score and overall happiness score
m_corrupt <- lm(Score ~ Perceptions_of_corruption, data = worldhappiness)

m_corrupt %>%
  tidy() %>%
  select(term, estimate) 


# Visualization of linear model

#ggplot(data = worldhappiness, aes(x = Perceptions_of_corruption,

ggplot(data = m_corrupt, aes(x = Perceptions_of_corruption,
                              y = Score)) + 
  geom_point(size = 0.8) + 
  geom_smooth(method = lm, color = "blue", size = 0.5) +
  labs(title = "Linear model for relationship between perceptions of corruption
and overall happiness score",
       subtitle = "Moderate, positive assocation",
       x = "Perceptions of corruption score",
       y = "Overall happiness score")

#Confidence interval for linear model above 
confint_tidy(m_corrupt, conf.level = 0.95) %>% 
  slice(2)

```

<<<<<<< HEAD

### Discussion

Based on data from the World Happiness Report, we aimed to explore how some factors of interest affected overall happiness in a country. We found that GDP per capita, Social Support, and Life Expectancy were all strongly correlated with the overall happiness score, and Perceptions of Corruption (reverse-scored) was moderately correlated. Furthermore, we wanted to know whether happiness was independent of country. Essentially, does the average individual’s happiness depend on the country that they live in? We found that happiness varies significantly from country to country. On top of that, some regions have high concentrations of 
High-, mid-, and low-happiness, suggesting that region also plays a role. For example, while North America, Nordic countries, and Oceania have very high levels of overall happiness, regions like Central Africa and South Asia have lower levels of overall happiness. 

While thought was put into the variables selected for investigation, the scope of our analysis was limited by only looking at GDP per capita, Perceptions of Corruption, Social Support, and Life Expectancy with respect to the overall Score. Additionally, evaluating each category independently when considering the linear models does not account for the likelihood that one variable may not be entirely independent of the other. While the conditions appeared to be met for the use of the linear model, some of the spreads did not appear to be completely normal which may impact the validity of the conclusions drawn. 

Considering that the data was collected through Gallup, a group well-respected for proper data collection, it can be evaluated as reliable. However, the translation of particular interviews and surveys into quantitative numbers leaves room for subjectivity to affect the data. While a variable such as GDP per capita is more concrete, something such as Perceptions of Corruption may be dependent on other factors such as access to education or level of freedom of the media. Consequently, the results of data analysis should be interpreted with this in mind. 

We were unable to reject the null hypothesis for our chi-square test for happiness and region, but there is a very likely possibility that we made a type II error. In order to perform a Pearson’s chi-squared test, four conditions have to be satisfied: simple random sample, sample size, expected cell count, and independence. Based on the description of the dataset, the survey was random, enough people were sampled, and the people sampled were independent of each other. Due to the nature of our data, however, expected counts for several cells were smaller than 5, and so the test loses a lot of accuracy. A solution to this would be to add the field simulate.p.value = TRUE to the chi-squared test, which uses the Monte Carlo method to obtain a p-value from random sampling.

Going forward, we would hope to study what specific factors lead to happiness among a general population within a country. In order to do this, we would need more variables that affect people’s lives: e.g. level of infrastructure, quality of healthcare, quality of education, safety. We might also seek to answer questions like the following: do the factors that predict happiness vary by region? Why are some regions happier than others? What factor is the most important for happiness across the board?
=======
### Life Expectancy
```{r linear-model-life-expectancy, message=FALSE, warning=FALSE}
life_expectancy <- worldhappiness %>% 
  filter(!is.na(Healthy_life_expectancy)) %>% 
  select(Country, Score, Healthy_life_expectancy, year)

life_expectancy %>% 
  summarize(r_overall = cor(Score, Healthy_life_expectancy))

m_life <- lm(Score ~ Healthy_life_expectancy, data = worldhappiness)

m_life %>%
  tidy() %>%
  select(term, estimate) 

ggplot(data = life_expectancy, aes(x = Healthy_life_expectancy, y = Score)) + 
  geom_point(size = 0.8) + 
  geom_smooth(method = lm, color = "blue", size = 0.5) +
  theme_bw() +
  labs(title = "Linear model for relationship between healthy life expectancy and overall happiness score",
       subtitle = "Strong, positive correlation", x = "Healthy Life Expectancy Score",
       y = "Overall Happiness Score")
```

### Social Support

```{r linear-model-soc-support, warning=FALSE, message=FALSE}
#Sample stat.
socsup <- worldhappiness %>% 
  filter(!is.na(Social_support)) %>% 
  select(Country, Score, Social_support, year)

socsup %>% 
  summarize(r_overall = cor(Score, Social_support))

#Create tidy for linear model
m_score_socsup <- lm(Score ~ Social_support, data = worldhappiness)

m_score_socsup %>%
  tidy() %>%
  select(term, estimate)

#Conf. Interval
broom::confint_tidy(m_score_socsup, conf.level = 0.95)

#Model
ggplot(data = socialsupport, mapping = aes(x = Social_support, y = Score)) + 
  geom_point(size = 0.3) + 
  geom_smooth(method = "lm", color = "red", size = 0.6) + 
  labs(title = "Linear model for rltn. b/w Social Support and Happiness Score", 
       subtitle = "For the world in 2018-2019", x = "Social Support Score",
       y = "Happiness Score") + 
  theme_minimal()
```
>>>>>>> 53415d8ce2813c3205a40fdc5f99905986503676
