---
title: "Final Project: An Evaluation of the World Happiness Report"
author: "Anna MacFarlane, Edgar Salas, Jerry Fu, Taalin RaoShah"
date: "11/4/2020"
output:
  pdf_document: default
  html_document: default
--- 

### Introduction

CodeStone chose to explore the data from the World Happiness Reports of 2018 and 2019, published by the Sustainable Development Network. According to the WHR, this data is derived from the Gallup World Poll, systematic telephone surveys and in person interviews in over 160 countries whose surveys claim to represent 80%+ of the population (2014). The calls are made via random phone number generation and randomly selecting households (GWP, 2014). The data sets from each year include 312 cases, each representing the data for a particular country. The original variables in the data set included the overall rank according to happiness score, country name, happiness score, and then 6 variables that were used to calculate the happiness score in the WHRâ€™s analysis. These are GDP per capita, social support, healthy life expectancy, freedom to make life choices, generosity, and perceptions of corruption, all of which are expanded upon in the methodology section of this report. Additionally, we added variables for year as well as region to further our analysis. 

Generally, we want to explore the following question: what factors contribute to the differences in happiness scores between countries in North America and Australia versus Western Europe? Both regions are relatively comparable in terms of financial and political structures, but Western Europe contains the Nordic countries which consistently score highest in the World Happiness reports. With this, questions are raised as to what contributes to such happiness in this region of the world.

Considering the concerning state of our world in 2020, including the worsening effects of climate change, threats to democracy, and much more, we found it topical and insightful to evaluate what contributes to happiness within nations and between regions across the globe. The first World Happiness Report, published in 2012, presents the report as a means of grappling with the countless contradictions that exist in modern society such as the balance between pursuing economic success versus protecting the environment or the tradeoffs between personal profit and community trust (Helliwell et al., 2012). Eight years later, these paradoxes persit, and the potential solutions are closely linked to definitions of morality, heightening their controversy. Considering the continued debate over such questions, we believe there are grounds for further investigation into trends of happiness over time and the factors that contribute to it.



```{r setup-packages, message = FALSE, warning = FALSE, echo = FALSE}
library(tidyverse)
library(plyr) #package for join command
library(maps) #package for world map
library(broom)
```

```{r load-datasets, message = FALSE, warning = FALSE, echo = FALSE}
report_2018 <- read_csv("data/2018.csv") %>% 
  mutate(year = "2018",
         `Perceptions of corruption` = as.numeric(`Perceptions of corruption`))
report_2019 <- read_csv("data/2019.csv") %>% 
  mutate(year = "2019")
country_region <- read_csv("data/2020.csv") %>% 
  mutate(year = "2020") %>% 
  select(`Country name`, `Regional indicator`)

names(country_region) <- c("Country", "Region")
names(report_2018) <- str_replace_all(names(report_2018), c(" " = "_"))
names(report_2019) <- str_replace_all(names(report_2018), c(" " = "_"))

worldhappiness <- full_join(report_2018, report_2019) 
worldhappiness <- worldhappiness %>% 
  rename(c("Country_or_region" = "Country")) %>% 
  left_join(country_region)

tidy_frame <- data.frame(matrix(unlist(worldhappiness), nrow = length(worldhappiness), byrow = T))

glimpse(worldhappiness)
```

```{r add-region, echo = FALSE}
#add regions to rows with missing Region column
worldhappiness <- worldhappiness %>% 
  mutate(Region = ifelse(Country == "Taiwan", "East Asia", Region),
         Region = ifelse(Country == "Qatar", "Middle East and North Africa", Region),
         Region = ifelse(Country == "Trinidad & Tobago", "Latin America and Caribbean", Region),
         Region = ifelse(Country == "Belize", "Latin America and Caribbean", Region),
         Region = ifelse(Country == "Northern Cyprus", "Middle East and North Africa", Region),
         Region = ifelse(Country == "Hong Kong", "East Asia", Region),
         Region = ifelse(Country == "Bhutan", "South Asia", Region),
         Region = ifelse(Country == "Somalia", "Middle East and North Africa", Region),
         Region = ifelse(Country == "Sudan", "Middle East and North Africa", Region),
         Region = ifelse(Country == "Angola", "Middle East and North Africa", Region),
         Region = ifelse(Country == "Syria", "Middle East and North Africa", Region),
         Region = ifelse(Country == "North Macedonia", "Central and Eastern Europe", Region))

view(worldhappiness)
```


### Is there a relationship between region of the world and happiness score?

```{r world-map, fig.width = 10, fig.height = 5, echo = FALSE}
world_map <- map_data("world") %>% 
  mutate(region = ifelse(region == "USA", "United States", region)) %>% 
  mutate(region = ifelse(region == "Democratic Republic of the Congo", "Congo (Kinshasa)", region))
  
happiness_score_map <- left_join(worldhappiness, world_map, by = c("Country" = "region"))
ggplot(happiness_score_map, aes(x = long, y = lat, group = group)) +
  geom_polygon(aes(fill = Score), color = "white") +
  labs(title = "World Map", subtitle = "colored by Happiness Score", x = "", y = "") +
  scale_fill_viridis_c(option = "D")
```
https://www.datanovia.com/en/blog/how-to-create-a-map-using-ggplot2/

$H_0$: There is no association between region of the world and happiness score.
$H_a$: There is an association between region of the world and happiness score.
```{r chi-sq-region-score, echo = FALSE}
chisq.test(worldhappiness$Score, worldhappiness$Region, simulate.p.value = TRUE)
```
With a simulated p-value of 0.0004998 which is less than our $\alpha = 0.05$, we have
sufficient evidence to reject the null hypothesis in favor of the alternative hypothesis
and conclude that there is an association between region of the world and happiness score.

### Summary Statistics
```{r summary-statistics, echo = FALSE}
WE <- worldhappiness %>% 
  filter(Region == "Western Europe")
NorthAmerica <- worldhappiness %>% 
  filter(Region == "North America and ANZ")

worldhappiness %>% 
  filter(Region == "Western Europe") %>% 
  summarize(WE_mean_happiness = mean(Score), median_score = median(Score), SD = sd(Score))

worldhappiness %>%
  filter(Region == "North America and ANZ") %>%
  summarize(NA_mean_happiness = mean(Score), median_score = median(Score), SD = sd(Score))
```


```{r create-function, echo = FALSE}
diff_means <- function(variable, n_sims){
  boot_diffs <- numeric(n_sims)

  for(i in 1:n_sims){
    indices_WE <- sample(1:nrow(WE), replace = T)
    indices_NA <- sample(1:nrow(NorthAmerica), replace = T)
  
    temp_WE <- WE %>% 
      slice(indices_WE) %>% 
      summarize(mean_WE = mean(get(variable))) %>% 
      select(mean_WE) %>% 
      pull()
    temp_NA <- NorthAmerica %>% 
      slice(indices_NA) %>% 
      summarize(mean_NA = mean(get(variable))) %>% 
      select(mean_NA) %>% 
      pull()

    boot_diffs[i] <- temp_WE - temp_NA
  } 
  boot_diffs <- tibble(diffs = boot_diffs)

  offset <- boot_diffs %>% 
    summarize(offset = 0 - mean(diffs)) %>% 
    pull()
  null_dist <- boot_diffs %>% 
    mutate(centered_diffs = diffs + offset) %>% 
    select(centered_diffs)
  obs_diff <- boot_diffs %>% 
    summarize(obs_diff = mean(diffs)) %>% 
    pull()
  p_val <- null_dist %>% 
    mutate(extreme = ifelse(centered_diffs > abs(obs_diff), 1, 0)) %>% 
    summarize(p_val = mean(extreme)) 

  return(list(p_val = p_val, null_dist = null_dist, obs_diff = obs_diff))
}
```


Each of the simulation-based hypothesis tests used to evaluate the variables contributing to overall happiness score will be evaluated at the $\alpha =$ 0.05 level.

Generally, our null hypothesis states that the mean score for a particular variable in Western Europe is less than or equal to the mean score for that same variable in North America, Australia, and New Zealand. Our alternative hypothesis therefore is that the mean score for a particular variable in Western Europe is greater than that of the mean score for that variable in North America, Australia, and New Zealand. 

$H_0$: $\mu_{WE}$ <= $\mu_{NA, ANZ}$ 

$H_A$: $\mu_{WE}$ > $\mu_{NA, ANZ}$ 

### GDP per capita

```{r gdp, echo = FALSE}
set.seed(714)
worldhappiness %>% 
  filter(Region == "Western Europe") %>%
  summarize(WE_GDP = mean(GDP_per_capita))

worldhappiness %>%
  filter(Region == "North America and ANZ") %>%
  summarize(NA_ANZ_GDP = mean(GDP_per_capita))

bootstrap <- diff_means(variable = "GDP_per_capita", 1000)

bootstrap$p_val
ggplot(bootstrap$null_dist, aes(x = centered_diffs)) +
  geom_histogram(binwidth = 0.005,
                 fill = "skyblue", 
                 color = "darkblue") +
  geom_vline(xintercept = bootstrap$obs_diff, color = "tomato", lwd = 2) +
  labs(title = "Simulated null distribution of difference in GDP per capita", 
       x = "Difference in mean",
       y = "Count")
```

### Social Support

```{r social-support, echo = FALSE}
set.seed(949)
worldhappiness %>% 
  filter(Region == "Western Europe") %>%
  summarize(WE_Soc_Support = mean(Social_support))

worldhappiness %>%
  filter(Region == "North America and ANZ") %>%
  summarize(NA_ANZ_Soc_Support = mean(Social_support))

bootstrap <- diff_means(variable = "Social_support", 1000)

bootstrap$p_val

ggplot(bootstrap$null_dist, aes(x = centered_diffs)) +
  geom_histogram(binwidth = 0.005,
                 fill = "skyblue", 
                 color = "darkblue") +
  geom_vline(xintercept = bootstrap$obs_diff, color = "tomato", lwd = 2) +
  labs(title = "Simulated null distribution of difference in social support", 
       x = "Difference in mean",
       y = "Count")
```

### Freedom to make life choices 

```{r freedom-life-choices, echo = FALSE}
set.seed(1)

worldhappiness %>% 
  filter(Region == "Western Europe") %>%
  summarize(WE_Life_Choices = mean(Freedom_to_make_life_choices))

worldhappiness %>%
  filter(Region == "North America and ANZ") %>%
  summarize(NA_ANZ_Life_Choices = mean(Freedom_to_make_life_choices))

bootstrap <- diff_means(variable = "Freedom_to_make_life_choices", 1000)

bootstrap$p_val

ggplot(bootstrap$null_dist, aes(x = centered_diffs)) +
  geom_histogram(binwidth = 0.005,
                 fill = "skyblue", 
                 color = "darkblue") +
  geom_vline(xintercept = bootstrap$obs_diff, color = "tomato", lwd = 2) +
  labs(title = "Simulated null distribution of difference in freedom to make life choices",
       x = "Difference in mean", y = "Count")
```
The calculated p-value of 0.024 is significant at the $\alpha =$ 0.05 level, indicating that we can reject the null hypothesis. Therefore, there is statistically significant evidence to suggest that the mean freedom to make life choices score in Western Europe is greater than that of North America, Australia, and New Zealand. 


### Generosity

```{r generosity, echo = FALSE}
set.seed(2)

worldhappiness %>% 
  filter(Region == "Western Europe") %>%
  summarize(WE_Gen = mean(Generosity))

worldhappiness %>%
  filter(Region == "North America and ANZ") %>%
  summarize(NA_ANZ_Gen = mean(Generosity))

bootstrap <- diff_means(variable = "Generosity", 1000)

bootstrap$p_val

ggplot(bootstrap$null_dist, aes(x = centered_diffs)) +
  geom_histogram(binwidth = 0.005,
                 fill = "skyblue", 
                 color = "darkblue") +
  geom_vline(xintercept = bootstrap$obs_diff, color = "tomato", lwd = 2) +
  labs(title = "Simulated null distribution of difference in generosity",
       x = "Difference in mean", y = "Count")
```
The calculated p-value of 0 is significant at the $\alpha =$ 0.05 level, indicating that we can reject the null hypothesis. Therefore, there is statistically significant evidence to suggest that the mean generosity score in Western Europe is greater than that of North America, Australia, and New Zealand. 


### Life Expectancy

```{r LE, echo = FALSE}
worldhappiness %>% 
  filter(Region == "Western Europe") %>%
  summarize(WE_life_expectancy = mean(Healthy_life_expectancy))

worldhappiness %>%
  filter(Region == "Western Europe") %>%
  summarize(RestofW_life_expectancy = mean(Healthy_life_expectancy))

bootstrap <- diff_means(variable = "Healthy_life_expectancy", 1000)

bootstrap$p_val

ggplot(bootstrap$null_dist, aes(x = centered_diffs)) +
  geom_histogram(binwidth = 0.005,
                 fill = "skyblue", 
                 color = "darkblue") +
  geom_vline(xintercept = bootstrap$obs_diff, color = "tomato", lwd = 2) +
  labs(title = "Simulated null distribution of difference in life expectancy", 
       x = "Difference in mean",
       y = "Count")
```

