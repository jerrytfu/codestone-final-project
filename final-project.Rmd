---
title: "Final Project: An Evaluation of the World Happiness Report"
author: "Anna MacFarlane, Edgar Salas, Jerry Fu, Taalin RaoShah"
date: "11/4/2020"
output:
  pdf_document: default
  html_document: default
--- 

## INTRODUCTION

CodeStone chose to explore the data from the World Happiness Reports of 2018 and 2019, published by the Sustainable Development Network. According to the WHR, this data is derived from the Gallup World Poll, systematic telephone surveys and in person interviews in over 160 countries whose surveys claim to represent 80%+ of the population [1]. The calls are made via random phone number generation and randomly selecting households [2]. The data sets from each year include 312 cases, each representing the data for a particular country. The original variables in the data set included the overall rank according to happiness score, country name, happiness score, and then 6 variables that were used to calculate the happiness score in the WHR’s analysis. These are GDP per capita, social support, healthy life expectancy, freedom to make life choices, generosity, and perceptions of corruption, all of which are expanded upon below. Additionally, we added variables for year as well as region to further our analysis. 

Variable Sources and Definitions
	
Happiness Score: Happiness score is a self-reported measure of overall current life satisfaction. This was measured by asking respondents, “Please imagine a ladder, with steps numbered from 0 at the bottom to 10 at the top. The top of the ladder represents the best possible life for you and the bottom of the ladder represents the worst possible life for you. On which step of the ladder would you say you personally feel you stand at this time?” The average of these values represents respective countries and regions [3][4]. 

GDP per capita: PPP (purchasing power parity) is a rate of conversion which attempts to equalize the purchasing power across all different currencies. The World Happiness Report sources its GDP per capita in PPP values from the 2017 and 2018 World Development Indicators respectively. This value is logged. [3][4]. 

Social Support: Social support is a self-reported measure of whether or not the respondent feels they can be helped. Specifically, respondents were asked, “If you were in trouble, do you have relatives or friends you can count on to help you whenever you need them, or not?” and responded with 0 or 1 (no or yes). The average for each respective country or region creates this value [3][4]. 

Life Expectancy: Life expectancy data was extrapolated from the WHOs health observation data up to 2016. Where missing, life expectancy data for certain countries was found using research and government tools [3][4]. 

Perceptions of Corruption: Perception of Corruption is a self-reported measure of whether or not respondents feel there is active corruption within government and business. Specifically, respondents were asked, “Is corruption widespread throughout the government or not” and “Is corruption widespread within businesses or not?” and responded to both with 0 or 1 (no or yes). The average for each respective country or region creates this value [3][4]. Note: A higher value for this measure represents a lower perception of corruption.


Generally, we want to explore the following question: what factors contribute to the differences in happiness scores between countries in North America and Australia versus Western Europe? Both regions are relatively comparable in terms of financial and political structures, but Western Europe contains the Nordic countries which consistently score highest in the World Happiness reports. With this, questions are raised as to what contributes to such happiness in this region of the world.

Considering the concerning state of our world in 2020, including the worsening effects of climate change, threats to democracy, and much more, we found it topical and insightful to evaluate what contributes to happiness within nations and between regions across the globe. The first World Happiness Report, published in 2012, presents the report as a means of grappling with the countless contradictions that exist in modern society such as the balance between pursuing economic success versus protecting the environment or the tradeoffs between personal profit and community trust [5]. Eight years later, these paradoxes persit, and the potential solutions are closely linked to definitions of morality, heightening their controversy. Considering the continued debate over such questions, we believe there are grounds for further investigation into trends of happiness over time and the factors that contribute to it.




```{r setup-packages, message = FALSE, warning = FALSE, echo = FALSE}
library(tidyverse)
library(plyr) #package for join command
library(maps) #package for world map
library(broom)
library(kableExtra) #package for table
```

```{r load-datasets, message = FALSE, warning = FALSE, echo = FALSE}
report_2018 <- read_csv("data/2018.csv") %>% 
  mutate(year = "2018",
         `Perceptions of corruption` = as.numeric(`Perceptions of corruption`))
report_2019 <- read_csv("data/2019.csv") %>% 
  mutate(year = "2019")
country_region <- read_csv("data/2020.csv") %>% 
  mutate(year = "2020") %>% 
  select(`Country name`, `Regional indicator`)

names(country_region) <- c("Country", "Region")
names(report_2018) <- str_replace_all(names(report_2018), c(" " = "_"))
names(report_2019) <- str_replace_all(names(report_2018), c(" " = "_"))

worldhappiness <- full_join(report_2018, report_2019) 
worldhappiness <- worldhappiness %>% 
  rename(c("Country_or_region" = "Country")) %>% 
  left_join(country_region)
```

```{r add-region, echo = FALSE}
#add regions to rows with missing Region column
worldhappiness <- worldhappiness %>% 
  mutate(Region = ifelse(Country == "Taiwan", "East Asia", Region),
         Region = ifelse(Country == "Qatar", "Middle East and North Africa", Region),
         Region = ifelse(Country == "Trinidad & Tobago", "Latin America and Caribbean", Region),
         Region = ifelse(Country == "Belize", "Latin America and Caribbean", Region),
         Region = ifelse(Country == "Northern Cyprus", "Middle East and North Africa", Region),
         Region = ifelse(Country == "Hong Kong", "East Asia", Region),
         Region = ifelse(Country == "Bhutan", "South Asia", Region),
         Region = ifelse(Country == "Somalia", "Middle East and North Africa", Region),
         Region = ifelse(Country == "Sudan", "Middle East and North Africa", Region),
         Region = ifelse(Country == "Angola", "Middle East and North Africa", Region),
         Region = ifelse(Country == "Syria", "Middle East and North Africa", Region),
         Region = ifelse(Country == "North Macedonia", "Central and Eastern Europe", Region))
```

## METHODOLOGY

### Chi-square test

Is there a relationship between region of the world and happiness score?

Description of chi square test for methodology 

```{r world-map, fig.width = 10, fig.height = 5, echo = FALSE}
world_map <- map_data("world") %>% 
  mutate(region = ifelse(region == "USA", "United States", region)) %>% 
  mutate(region = ifelse(region == "Democratic Republic of the Congo", "Congo (Kinshasa)", region))
  
happiness_score_map <- left_join(worldhappiness, world_map, by = c("Country" = "region"))
ggplot(happiness_score_map, aes(x = long, y = lat, group = group)) +
  geom_polygon(aes(fill = Score), color = "white") +
  labs(title = "World Map", subtitle = "colored by Happiness Score", x = "", y = "") +
  scale_fill_viridis_c(option = "D")
```
https://www.datanovia.com/en/blog/how-to-create-a-map-using-ggplot2/

$H_0$: There is no association between region of the world and happiness score.
$H_a$: There is an association between region of the world and happiness score.

```{r chi-sq-region-score, echo = FALSE}
set.seed(714)
chisq.test(worldhappiness$Score, worldhappiness$Region, simulate.p.value = TRUE)
```

### Summary Statistics

Description of summary statistics for methodology

```{r summary-statistics, echo = FALSE}
WE <- worldhappiness %>% 
  filter(Region == "Western Europe")
NorthAmerica <- worldhappiness %>%
  mutate(Region = ifelse(Country == "Mexico", "North America and ANZ", Region)) %>% 
  filter(Region == "North America and ANZ") %>% 
  filter(Country != "Australia", Country != "New Zealand")

WE_summary_stats <- WE %>% 
  summarize(WE_mean_happiness = mean(Score), WE_mean_GDP = mean(GDP_per_capita), 
            WE_mean_social_support = mean(Social_support), 
            WE_healthy_life_expectancy = mean(Healthy_life_expectancy),
            WE_mean_generosity = mean(Generosity), WE_mean_corruption = mean(Perceptions_of_corruption))

NA_summary_stats <- NorthAmerica %>% 
  summarize(NA_mean_happiness = mean(Score), NA_mean_GDP = mean(GDP_per_capita), 
            NA_mean_social_support = mean(Social_support), 
            NA_healthy_life_expectancy = mean(Healthy_life_expectancy),
            NA_mean_generosity = mean(Generosity), NA_mean_corruption = mean(Perceptions_of_corruption))

table <- t(map2_dfr(WE_summary_stats, NA_summary_stats, ~ tibble(`Western Europe` = .x, `North America` = .y)))

colnames(table) <- c("Happiness Score", "GDP", "Social Support", 
                     "Healthy Life Expectancy", "Generosity", "Corruption")

kbl(table, caption = "Figure 1: Mean Scores for World Happiness Report Categories") %>% 
  kable_styling(c("hover", "striped")) %>% 
  column_spec(2, color = "blue")
```


```{r create-function, echo = FALSE}
diff_means <- function(variable, n_sims){
  boot_diffs <- numeric(n_sims)

  for(i in 1:n_sims){
    indices_WE <- sample(1:nrow(WE), replace = T)
    indices_NA <- sample(1:nrow(NorthAmerica), replace = T)
  
    temp_WE <- WE %>% 
      slice(indices_WE) %>% 
      summarize(mean_WE = mean(get(variable))) %>% 
      select(mean_WE) %>% 
      pull()
    temp_NA <- NorthAmerica %>% 
      slice(indices_NA) %>% 
      summarize(mean_NA = mean(get(variable))) %>% 
      select(mean_NA) %>% 
      pull()

    boot_diffs[i] <- temp_WE - temp_NA
  } 
  boot_diffs <- tibble(diffs = boot_diffs)

  offset <- boot_diffs %>% 
    summarize(offset = 0 - mean(diffs)) %>% 
    pull()
  null_dist <- boot_diffs %>% 
    mutate(centered_diffs = diffs + offset) %>% 
    select(centered_diffs)
  obs_diff_WE <- WE %>% 
    summarize(obs_diff = mean(get(variable))) %>% 
    pull()
  obs_diff_NA <- NorthAmerica %>% 
    summarize(obs_diff = mean(get(variable))) %>% 
    pull()
  obs_diff <- obs_diff_WE - obs_diff_NA
  p_val <- null_dist %>% 
    mutate(extreme = ifelse(centered_diffs > obs_diff, 1, 0)) %>% 
    summarize(p_val = mean(extreme)) 

  return(list(p_val = p_val, null_dist = null_dist, obs_diff = obs_diff))
}
```

### Violin Plot Visualizations 

Description of visualizations for methodology.

```{r score-distributions, echo = FALSE}
graph <- worldhappiness %>% 
  filter(Region == "North America and ANZ" | Region == "Western Europe") %>% 
  mutate(region = case_when(
    Region == "North America and ANZ" ~ "North America",
    Region == "Western Europe" ~ "Western Europe"
  )) %>% 
  group_by(region)

ggplot(data = graph, aes(factor(region), Score)) +
  geom_violin() +
  geom_boxplot(width = 0.1, outlier.color = "red") +
  labs(x = "Region",
       y = "Overall happiness score",
       title = "Distributions of overall happiness scores by region",
       subtitle = "Red points denoting outliers") 

ggplot(data = graph, aes(factor(region), GDP_per_capita)) +
  geom_violin() +
  geom_boxplot(width = 0.1, outlier.color = "red") +
  labs(x = "Region",
       y = "GDP per capita score",
       title = "Distributions of GDP per capita scores by region",
       subtitle = "Red points denoting outliers") 

ggplot(data = graph, aes(factor(region), Social_support)) +
  geom_violin() +
  geom_boxplot(width = 0.1, outlier.color = "red") +
  labs(x = "Region",
       y = "Social support score",
       title = "Distributions of social support scores by region",
       subtitle = "Red points denoting outliers") 

ggplot(data = graph, aes(factor(region), Healthy_life_expectancy)) +
  geom_violin() +
  geom_boxplot(width = 0.1, outlier.color = "red") +
  labs(x = "Region",
       y = "Healthy life expectancy score",
       title = "Distributions of healthy life expectancy scores by region",
       subtitle = "Red points denoting outliers") 

ggplot(data = graph, aes(factor(region), Freedom_to_make_life_choices)) +
  geom_violin() +
  geom_boxplot(width = 0.1, outlier.color = "red") +
  labs(x = "Region",
       y = "Freedom to make life choices score",
       title = "Distributions of freedom to make life choices scores by region",
       subtitle = "Red points denoting outliers") 

ggplot(data = graph, aes(factor(region), Generosity)) +
  geom_violin() +
  geom_boxplot(width = 0.1, outlier.color = "red") +
  labs(x = "Region",
       y = "Generosity score",
       title = "Distributions of generosity scores by region",
       subtitle = "Red points denoting outliers") 

ggplot(data = graph, aes(factor(region), Perceptions_of_corruption)) +
  geom_violin() +
  geom_boxplot(width = 0.1, outlier.color = "red") +
  labs(x = "Region",
       y = "Perceptions of corruption score",
       title = "Distributions of perceptions of corruption scores by region",
       subtitle = "Red points denoting outliers") 
```
### Simulation based hypothesis testing

Next, we conducted simulation-based hypothesis tests for each of the variables contributing to overall happiness score to evaluate whether there Western Europe has a statistically significantly higher mean score for a particular variable between the two regions. 

Each of the simulation-based hypothesis tests used to evaluate the variables contributing to overall happiness score will be evaluated at the $\alpha =$ 0.05 level.

Generally, our null hypothesis states that the mean score for a particular variable in Western Europe is less than or equal to the mean score for that same variable in North America. Our alternative hypothesis therefore is that the mean score for a particular variable in Western Europe is greater than that of the mean score for that variable in North America. 

$H_0$: $\mu_{WE}$ <= $\mu_{NA}$ 

$H_A$: $\mu_{WE}$ > $\mu_{NA}$ 

#### GDP per capita

```{r gdp, echo = FALSE}
set.seed(714)

bootstrap <- diff_means(variable = "GDP_per_capita", 1000)

bootstrap$p_val
ggplot(bootstrap$null_dist, aes(x = centered_diffs)) +
  geom_histogram(binwidth = 0.005,
                 fill = "skyblue", 
                 color = "darkblue") +
  geom_vline(xintercept = bootstrap$obs_diff, color = "tomato", lwd = 2) +
  labs(title = "Simulated null distribution of difference in GDP per capita", 
       x = "Difference in mean",
       y = "Count")
```

#### Social Support

```{r social-support, echo = FALSE}
set.seed(949)

bootstrap <- diff_means(variable = "Social_support", 1000)

bootstrap$p_val

ggplot(bootstrap$null_dist, aes(x = centered_diffs)) +
  geom_histogram(binwidth = 0.005,
                 fill = "skyblue", 
                 color = "darkblue") +
  geom_vline(xintercept = bootstrap$obs_diff, color = "tomato", lwd = 2) +
  labs(title = "Simulated null distribution of difference in social support", 
       x = "Difference in mean",
       y = "Count")
```

#### Freedom to make life choices 

```{r freedom-life-choices, echo = FALSE}
set.seed(1)

bootstrap <- diff_means(variable = "Freedom_to_make_life_choices", 1000)

bootstrap$p_val

ggplot(bootstrap$null_dist, aes(x = centered_diffs)) +
  geom_histogram(binwidth = 0.005,
                 fill = "skyblue", 
                 color = "darkblue") +
  geom_vline(xintercept = bootstrap$obs_diff, color = "tomato", lwd = 2) +
  labs(title = "Simulated null distribution of difference in freedom to make life choices",
       x = "Difference in mean", y = "Count")
```


#### Generosity

```{r generosity, echo = FALSE}
set.seed(2)

bootstrap <- diff_means(variable = "Generosity", 1000)

bootstrap$p_val

ggplot(bootstrap$null_dist, aes(x = centered_diffs)) +
  geom_histogram(binwidth = 0.005,
                 fill = "skyblue", 
                 color = "darkblue") +
  geom_vline(xintercept = bootstrap$obs_diff, color = "tomato", lwd = 2) +
  labs(title = "Simulated null distribution of difference in generosity",
       x = "Difference in mean", y = "Count")
```


#### Life Expectancy

```{r LE, echo = FALSE}
set.seed(2020)

bootstrap <- diff_means(variable = "Healthy_life_expectancy", 1000)

bootstrap$p_val

ggplot(bootstrap$null_dist, aes(x = centered_diffs)) +
  geom_histogram(binwidth = 0.005,
                 fill = "skyblue", 
                 color = "darkblue") +
  geom_vline(xintercept = bootstrap$obs_diff, color = "tomato", lwd = 2) +
  labs(title = "Simulated null distribution of difference in life expectancy", 
       x = "Difference in mean",
       y = "Count")
```

#### Perceptions of Corruption

```{r poc, echo = FALSE}
#Set seed
set.seed(5318008)

bootstrap <- diff_means(variable = "Perceptions_of_corruption", 1000)

bootstrap$p_val

#Graph
ggplot(bootstrap$null_dist, aes(x = centered_diffs)) +
  geom_histogram(binwidth = 0.01, fill = "skyblue", color = "darkblue") +
  geom_vline(xintercept = bootstrap$obs_diff, color = "tomato", lwd = 2) +
  labs(title = "Simulated Null Distribution of Difference in mean Perceptions of Corruption", 
       x = "Difference in Mean",
       y = "Count")

```


## RESULTS 

### Chi-square test 

With a simulated p-value of 0.1124 which is less than our $\alpha = 0.05$, we have
sufficient evidence to reject the null hypothesis in favor of the alternative hypothesis
and conclude that there is an association between region of the world and happiness score.


### Simulation-based hypothesis tests

#### GDP per capita:

Since the calculated p-value of 0.15 is not significant at the $\alpha =$ 0.05 level, we fail to reject the null hypothesis. Therefore, there is not statistically significant evidence to suggest that the mean GDP per capita score in Western Europe is greater than that of North America. 

#### Social support:

The calculated p-value of 0.08 is not significant at the $\alpha =$ 0.05 level, so we fail to reject the null hypothesis. Therefore, there is not statistically significant evidence to suggest that the mean social support score in Western Europe is greater than that of North America.

#### Freedom to make life choices

Since the calculated p-value of 0.56 is not significant at the $\alpha =$ 0.05 level, we fail to reject the null hypothesis. Therefore, there is not statistically significant evidence to suggest that the mean freedom to make life choices score in Western Europe is greater than that of North America. 

#### Generosity

The calculated p-value of 0.45 is not significant at the $\alpha =$ 0.05 level, so we fail to reject the null hypothesis. Therefore, there is not statistically significant evidence to suggest that the mean generosity score in Western Europe is greater than that of North America. 

#### Life expectancy

The calculated p-value of 0.01 is significant at the $\alpha =$ 0.05 level, so we can reject the null hypothesis. Therefore, there is statistically significant evidence to suggest that the mean life expectancy score in Western Europe is greater than that of North America. 

#### Perceptions of corruption

Since the calculated p-value of 0.14 is not significant at the $\alpha =$ 0.05 level, we fail to reject the null hypothesis. Therefore, there is not statistically significant evidence to suggest that the mean perceptions of corruption score in Western Europe is greater than that of North America. 

## DISCUSSION

